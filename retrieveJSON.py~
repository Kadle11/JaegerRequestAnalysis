import json
import requests


allProcs = {}
totalTime = 0.0

def getSpanMetrics(TraceID):
  global totalTime
  global AllProcs
  timePerProc = {}

  url = "http://localhost:16686/api/traces/"+str(TraceID.strip())
  response = requests.get(url)
  data = json.loads(response.text)

  with open("Request"+str(TraceID.strip())+".json", "w") as jFile:
      json.dump(data, jFile)  

  for proc in data["data"][0]["processes"]:
      allProcs[proc] =  data["data"][0]["processes"][proc]["serviceName"]
      timePerProc[proc] = 0

  for span in data["data"][0]["spans"]:
        timePerProc[span["processID"]] += int(span["duration"])
        totalTime +=  float(span["duration"])

  return timePerProc

def getAllTraces(File):
    procTimes = {}
    with open(File, "r") as allTraces:
        for TraceID in allTraces:
            timePerProc = getSpanMetrics(TraceID)
            for proc in timePerProc:
                if(allProcs[proc] in procTimes):
                    procTimes[allProcs[proc]] += timePerProc[proc]
                else:
                    procTimes[allProcs[proc]] = timePerProc[proc]

    
    print("Service,Time")
    for proc in procTimes:
        procTimes[proc] /= totalTime
        print(proc, ",", procTimes[proc])

getAllTraces("TraceLogs")



